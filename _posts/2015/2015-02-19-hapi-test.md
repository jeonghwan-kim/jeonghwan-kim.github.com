---
id: 208
title: Hapi í…ŒìŠ¤íŠ¸ ì½”ë“œ
date: 2015-02-19T18:50:23+00:00
author: Chris
layout: post
guid: http://whatilearn.com/?p=208
permalink: /hapi-test/
category: series
tags:
  - grunt
  - hapijs
  - lab
  - unit-test
---
í”„ë¡ íŠ¸ë„ ë§ˆì°¬ê°€ì§€ì§€ë§ŒÂ ë°±ì—”ë“œ ì„œë²„ë¥¼ ê°œë°œí• ìˆ˜ë¡ í…ŒìŠ¤íŠ¸ê°€ ì¤‘ìš”ì„±ì„ ì‹¤ê°í•œë‹¤.
ì„œë¹„ìŠ¤ëŠ” ì„œë²„ í˜¼ìì„œ ë™ì‘í•˜ëŠ” ê²ƒì´ ì•„ë‹ˆë¼ ëª¨ë°”ì¼, ì›¹ ë¸Œë¼ìš°ì ¸ ë“±ì˜ í´ë¼ì´ì–¸íŠ¸ì™€ í•¨ê»˜ ë™ì‘í•´ì•¼ í•˜ê¸° ë•Œë¬¸ì— ë‹¤ì–‘í•œ ì‹œë‚˜ë¦¬ì˜¤ì— ëŒ€ì‘í•  ìˆ˜ ìˆì–´ì•¼ í•œë‹¤.
ë˜í•œ í•œ ë²ˆ ë°œìƒí•œ ë²„ê·¸ëŠ” ì¬ë°œí•˜ì§€ ì•ŠëŠ”ë‹¤ëŠ” ê²ƒì„ ë³´ì¥í•´ì•¼ ë§ˆìŒ ë†“ê³  ì½”ë“œë¥¼ ìˆ˜ì •í•  ìˆ˜ ìˆë‹¤.
ë•Œë¬¸ì— í…ŒìŠ¤íŠ¸ ë¿ë§Œ ì•„ë‹ˆë¼ í…ŒìŠ¤íŠ¸ ê·œëª¨ê°€ ì»¤ì§ì— ë”°ë¼ ì´ì— ëŒ€í•œ í…ŒìŠ¤íŠ¸ ìë™í™”ì— ëŒ€í•´ì„œë„ ê³ ë¯¼í•˜ì§€ ì•Šì„ ìˆ˜ ì—†ë‹¤.

ì´ë²ˆ ê¸€ì€ Hapië¥¼ ì´ìš©í•œ Api ì„œë²„ ê°œë°œì‹œ í…ŒìŠ¤íŠ¸ ìë™í™”ê°€ ê·¸ ì£¼ì œë‹¤.

* Hapiì—ì„œ ì œê³µí•˜ëŠ” ìœ ë‹›í…ŒìŠ¤íŠ¸ ëª¨ë“ˆì¸ <a href="https://github.com/hapijs/lab">Lab</a>ê³¼
* ê²€ì¦ëª¨ë“ˆ <a href="https://github.com/hapijs/code#array">Code</a>,Â 
* ì´ë¥¼ í™œìš©í•œ REST Api ë‹¨ì—ì„œì˜ í…ŒìŠ¤íŠ¸ ì½”ë“œ ì‘ì„±ë²•,
* ê·¸ë¦¬ê³  í…ŒìŠ¤íŠ¸ ê²°ê³¼ì˜ ë¬¸ì„œí™”ê¹Œì§€ì˜ í…ŒìŠ¤íŠ¸ ê³¼ì •ì— ëŒ€í•´Â ë³´ì.


## ë¼ìš°íŒ… í…ŒìŠ¤íŠ¸

ìœ ë‹› í…ŒìŠ¤íŠ¸ë¼ê³  í•˜ë©´ í´ë˜ìŠ¤, í•¨ìˆ˜ ë‹¨ìœ„ ë“± í•˜ë‚˜ì˜ ì½”ë“œ ë©ì–´ë¦¬ë¥¼ í…ŒìŠ¤íŠ¸í•˜ëŠ” ê²ƒì„ ë§í•œë‹¤.
Api ì„œë²„ì—ì„œë„ í´ë˜ìŠ¤ì™€ í•¨ìˆ˜ê°€ ìˆê¸° ë•Œë¬¸ì— ê·¸ëŸ¬í•œ ëª¨ë“ˆë‹¨ìœ„ì˜ ìœ ë‹›í…ŒìŠ¤íŠ¸ê°€ ê°€ëŠ¥í•˜ë‹¤.
ê·¸ëŸ¬ë‚˜ ë³¸ ê¸€ì—ì„œëŠ” ìœ ë‹›í…ŒìŠ¤íŠ¸ê°€ ì•„ë‹Œ í”„ë¡œí† ì½œ ë‹¨ìœ„ì˜ í…ŒìŠ¤íŠ¸ ì½”ë“œë¥¼ ë‹¤ë£¬ë‹¤. API ì„œë²„ì˜ ê¶ê·¹ì ì¸ ëª©ì ì€ í”„ë¡œí† ì½œì„ í˜¸ì¶œí–ˆì„ ë•Œ ì˜ˆìƒë˜ëŠ” ê²°ê³¼ë¡œ ì‘ë‹µí•˜ëŠ” ê²ƒì´ê¸° ë•Œë¬¸ì— ì´ëŸ¬í•œ í”„ë¡œí† ì½œ ë‹¨ìœ„ì˜ í…ŒìŠ¤íŠ¸ê°€ ì¤‘ìš”í•˜ë‹¤ê³  ìƒê°í•œë‹¤.

ì§€ê¸ˆê¹Œì§€ ì‘ì„±í•œ ì½”ë“œì˜ í´ë”êµ¬ì¡°ë¥¼ ì‚´í´ë³´ì.
ë¼ìš°íŒ… ë‹¨ìœ„ë¡œ í´ë”ë¥¼ ì‘ì„±í•˜ê³ , ê° í´ë”ì—ëŠ” `index.js` `*.ctrl.js`, `*.valid.js`ê°€ ê°ê° ì¡´ì¬í•œë‹¤.
í…ŒìŠ¤íŠ¸ë¥¼ ìœ„í•´ `*.spec.js` íŒŒì¼ì„ ì¶”ê°€í•˜ì.
ë‹¤ì‹œ í•œ ë²ˆ ê° íŒŒì¼ì˜ ì—­í• ì„ ì„¤ëª…í•˜ë©´ ì•„ë˜ì™€ ê°™ë‹¤.

* `index.js`: ë¼ìš°íŒ… ì„¤ì •
* `*.ctrl.js`: ë¡œì§ êµ¬í˜„
* `*.valid.js`: íŒŒë¼ë§¤í„° ê²€ì¦
* `*.spec.js`: í…ŒìŠ¤íŠ¸ ì½”ë“œ


ì´ì „ í¬ìŠ¤íŠ¸ì—ì„œ êµ¬í˜„í•œ `/user` í”„ë¡œí† ì½œì— ëŒ€í•œ í…ŒìŠ¤íŠ¸ ì½”ë“œë¥¼ êµ¬í˜„í•´ ë³´ì.

Hapi ìœ ë‹›í…ŒìŠ¤íŠ¸ ëª¨ë“ˆì¸ __Lab__ ê³¼ ê²€ì¦ ëª¨ë“ˆ __Code__ ë¥¼ ì‚¬ìš©í•´ì„œ êµ¬í˜„í•œë‹¤.
Hapiì—ì„œëŠ” ìœ ë‹› í…ŒìŠ¤íŠ¸ì— ì–¸ê¸‰í•˜ëŠ” Test Suiteë¥¼ "experiment", Test CaseëŠ” "test"ë¼ê³  ë¶€ë¥¸ë‹¤.
ì¤‘ì²© experimentë¥¼ ê°€ì§ˆ ìˆ˜ ìˆê³  í…ŒìŠ¤íŠ¸ ì „ëµì— ë”°ë¼ì„œ í…ŒìŠ¤íŠ¸ ì¼€ì´ìŠ¤ë¥¼ êµ¬ì¡°í™” í•  ìˆ˜ ìˆë‹¤.

```javascript
'use strict';

var Code = require('code'); // ê²€ì¦ ëª¨ë“ˆ
var Lab = require('lab'); // ìœ ë‹› í…ŒìŠ¤íŠ¸ ëª¨ë“ˆ
var lab = exports.lab = Lab.script();
var path = require('path');

// ì„œë²„ ëª¨ë“ˆ
// ì„œë²„ ê°ì²´ë¥¼ í• ë‹¹í•œ ë¶€ë¶„ì—ì„œ module.exports = server ì½”ë“œë¥¼ ì¶”ê°€í•˜ì—¬
// ì„œë²„ ê°ì²´ë¥¼ ë…¸ì¶œì‹œì¼œì„œ ì‚¬ìš©í•´ì•¼ í•œë‹¤.
var app = require(path.join(__dirname, '../../index.js'));

// í…ŒìŠ¤íŠ¸ suite
lab.experiment('/users', function () {

  // í…ŒìŠ¤íŠ¸ ì¼€ì´ìŠ¤
  lab.test('GET', function (done) {
    var opts = {
      method: 'GET',
      url: '/users'
    };

    // ì„œë²„ êµ¬ë™
    app.inject(opts, function (res) {

      // Code ê²€ì¦ ëª¨ë“ˆë¡œ ê²°ê³¼ê°’ì„ ê²€ì¦í•œë‹¤.
      Code.expect(res.statusCode).to.be.equal(200);
      Code.expect(res.result).contain('users');
      Code.expect(res.result.users).to.be.an.array();

      // ë¹„ë™ê¸° ì½”ë“œì´ë¯€ë¡œ done() ì½œë°±í•¨ìˆ˜ë¡œ ì¢…ë£Œë¥¼ ì•Œë¦°ë‹¤.
      done();
    });
  });

});
```

ìœ„ ì½”ë“œì—ì„œëŠ” ìš°ë¦¬ê°€ êµ¬í˜„í•œ ì„œë²„ ê°ì²´ë¥¼ `require()` í•¨ìˆ˜ë¡œ ë¶ˆëŸ¬ì˜¨ë‹¤.
ê¸°ì¡´ì˜ ì„œë²„ ìƒì„± ì½”ë“œì— `server` ê°ì²´ë¥¼ ë…¸ì¶œì‹œí‚¤ëŠ” ì½”ë“œ ì¶”ê°€í•˜ì.

```javascript
var Hapi = require('hapi');

/* ì„œë²„ ê°ì²´ ìƒì„± ë° ì„¤ì • */

// ì„œë²„ ê°ì²´ë¥¼ ë…¸ì¶œí•œë‹¤.
module.exports = server;
```

ì‘ì„±í•œ í…ŒìŠ¤íŠ¸ ì½”ë“œë¥¼ ì•„ë˜ ëª…ë ¹ì–´ë¡œ ì‹¤í–‰í•´ë³´ì.
ì½˜ì†” í™”ë©´ì„ í†µí•´ í…ŒìŠ¤íŠ¸ ê²°ê³¼ë¥¼ í™•ì¸í•  ìˆ˜ ìˆë‹¤.

```
$ node_modules/lab/bin/lab users.spec.js
```

## ê¹”ë”í•œ í…ŒìŠ¤íŠ¸ë¥¼ ìœ„í•œ ì‘ì—…

Api ì„œë²„ í…ŒìŠ¤íŠ¸ë¥¼ ì—¬ëŸ¬ë²ˆ ìˆ˜í–‰í• ìˆ˜ë¡ ì„œë²„ì—ëŠ” í…ŒìŠ¤íŠ¸ ë°ì´í„°ê°€ ìŒ“ì´ê²Œ ëœë‹¤.
ì˜ˆë¥¼ ë“¤ì–´ POST í”„ë¡œí† ì½œì„ í…ŒìŠ¤íŠ¸ í•  ê²½ìš° ë°ì´í„°ë² ì´ìŠ¤ì— ë°ì´í„°ë¥¼ ì €ì¥í•œë‹¤ë©´ ë°ì´í„°ê°€ ê³„ì† ìŒ“ì´ê²Œ ëœë‹¤.
ì–´ì°¨í”¼ ê°œë°œì„œë²„ì—ì„œ í…ŒìŠ¤íŠ¸ í•œë‹¤ë©´ ìƒê´€ì—†ì„ ìˆ˜ë„ ìˆìœ¼ë‚˜ í…ŒìŠ¤íŠ¸ í›„ì—ëŠ” ê·¸ í”ì ì´ ë‚¨ì§€ ì•Šì•„ì•¼ í•œë‹¤ê³  ìƒê°í•œë‹¤.
ì´ë²ˆ í…ŒìŠ¤íŠ¸ ë¿ë§Œ ì•„ë‹ˆë¼ ë‹¤ë¥¸ í…ŒìŠ¤íŠ¸ì— ì˜í–¥ì„ ë¯¸ì¹ ìˆ˜ ìˆê¸° ë•Œë¬¸ì´ë‹¤.

Lab ëª¨ë“ˆì—ì„œëŠ” `before()`ì™€ `after()` í•¨ìˆ˜ë¥¼ ì§€ì›í•œë‹¤.
`test()`ë¡œ í…ŒìŠ¤íŠ¸ ì¼€ì´ìŠ¤ë¥¼ ì§„í–‰í•˜ê¸° ì „ì— ë­”ê°€ ì‘ì—…ì„ í•˜ê³  í…ŒìŠ¤íŠ¸ ì¢…ë£Œí›„ ë§ˆë¬´ë¦¬ ì‘ì—…ì„ ìœ„í•œ í•¨ìˆ˜ë‹¤.
`before()`ì—ì„  POST í”„ë¡œí† ì½œë¡œ í…ŒìŠ¤íŠ¸ ë°ì´í„°ë¥¼ ì…ë ¥í•˜ê³  `after()`ì—ì„œëŠ” DELETE í”„ë¡œí† ì½œë¡œ í…ŒìŠ¤íŠ¸ ë°ì´í„°ë¥¼ ì‚­ì œí•œë‹¤. Â 
`test()`ì—ì„œëŠ” GET, PUT í”„ë¡œí† ì½œì„ í…ŒìŠ¤íŠ¸í•œë‹¤.
`before()`/`after()`ëŠ” `experiment()`ì—ì„œ ê° ê° í•œë²ˆë§Œ ì‹¤í–‰ëœë‹¤.
ë§¤ í…ŒìŠ¤íŠ¸ë§ˆë‹¤ ì‹¤í–‰í•˜ê¸° ìœ„í•œ `beforeEach()`/`afterEach()`í•¨ìˆ˜ë„ ì§€ì›í•œë‹¤.

```javascript
'use strict';

var Code = require('code');
var Lab = require('lab');
var lab = exports.lab = Lab.script();
var path = require('path');
var app = require(path.join(__dirname, '../../index.js'));

lab.experiment('/users', function () {

  // í…ŒìŠ¤íŠ¸ ë°ì´í„°
  var tester = {
    name: 'Unit Tester'
  };

  // í…ŒìŠ¤íŠ¸ ì „ì— postë¡œ í…ŒìŠ¤íŠ¸ ìì›ì„ ì…ë ¥í•˜ëŠ” í”„ë¡œí† ì½œì„ í˜¸ì¶œí•œë‹¤.
  lab.before(function (done) {
    var opts = {
      method: 'POST',
      url: '/users',
      payload: {
        name: tester.name
      }
    };
    app.inject(opts, function (res) {
      Code.expect(res.statusCode).to.be.equal(201);
      tester.id = res.result.users.indexOf(tester.name);
      done();
    });
  });

  // í…ŒìŠ¤íŠ¸ ì¢…ë£Œ í›„ í…ŒìŠ¤íŠ¸ ìì›ì„ ì‚­ì œí•˜ëŠ” í”„ë¡œí† ì½œì„ í˜¸ì¶œí•œë‹¤.
  lab.after(function (done) {
    var opts = {
      method: 'DELETE',
      url: '/users?id=' + tester.id
    };
    app.inject(opts, function (res) {
      Code.expect(res.statusCode).to.be.equal(200);
      done();
    });
  });

  lab.test('GET', function (done) {
    var opts = {
      method: 'GET',
      url: '/users'
    };
    app.inject(opts, function (res) {
      Code.expect(res.statusCode).to.be.equal(200);
      Code.expect(res.result).contain('users');
      Code.expect(res.result.users).to.be.an.array();

      // before()ì—ì„œ ì…ë ¥í•œ í…ŒìŠ¤íŠ¸ ë°ì´í„°ë¥¼ í™•ì¸í•œë‹¤.
      Code.expect(res.result.users[tester.id]).to.be.equal(tester.name);

      done();
    });
  });

  lab.test('GET users/{id}', function (done) {
    var opts = {
      method: 'GET',
      url   : '/users/' + tester.id
    };
    app.inject(opts, function (res) {
      Code.expect(res.statusCode).to.be.equal(200);

      // before()ì—ì„œ ì…ë ¥í•œ í…ŒìŠ¤íŠ¸ ë°ì´í„°ë¥¼ í™•ì¸í•œë‹¤.
      Code.expect(res.result.user).to.be.equal(tester.name);
      done();
    });
  });

});
```

ë§Œì•½ í…ŒìŠ¤íŠ¸ê°€ ë§ì„ ê²½ìš° í•œ í…ŒìŠ¤íŠ¸ ì¼€ì´ìŠ¤ë§Œ ì‹¤í–‰í•  í•„ìš”ê°€ ìˆë‹¤.
ë°˜ëŒ€ë¡œ íŠ¹ì • í…ŒìŠ¤íŠ¸ëŠ” ìŠ¤í‚µí•˜ê³  ì‹¶ì„ ë•Œê°€ ìˆëŠ”ë° `lab.test()` í•¨ìˆ˜ì˜ ë‘ ë²ˆì§¸ íŒŒë¼ë©”í„°ë¡œ `{only: Boolean,Â skip: Boolena}` ê°ì²´ë¥¼ ë„˜ê²¨ì£¼ë©´ ê°€ëŠ¥í•˜ë‹¤.

í…ŒìŠ¤íŠ¸ íŒŒì¼ì´ ë§ì•„ì§€ë©´ ë§¤ë²ˆ ëª…ë ¹ì–´ë¡œ ì‹¤í–‰í•˜ê¸° ë¶ˆê°€ëŠ¥í•˜ë‹¤.
ë¦¬ëˆ…ìŠ¤ì— ë§ì´ ì‚¬ìš©í•˜ëŠ” Makefileë¥¼ í™œìš©í•˜ë©´ ì´ë¥¼ ì†ì‰½ê²Œ ê´€ë¦¬í•  ìˆ˜ ìˆë‹¤.

```makefile
all: users auth

users:
  node_modules/lab/bin/lab app/routes/users/*.spec.js

auth:
  node_modules/lab/bin/lab app/routes/auth/*.spec.js
```

/users í”„ë¡œí† ì½œì„ í…ŒìŠ¤íŠ¸í•  ë•ŒëŠ” `make user`ë¡œ ê°„ë‹¨íˆ ì‹¤í–‰í•œë‹¤.
`make` ëª…ë ¹ì–´ëŠ” ì „ì²´ í…ŒìŠ¤íŠ¸ë¥¼ ì‹¤í–‰í•œë‹¤.
Makefileì€ í”„ë¡œì íŠ¸ ë£¨íŠ¸í´ë”ì— ê´€ë¦¬í•˜ëŠ” ê²ƒì´ ì¢‹ê³ , ìŠ¤í˜ì´ìŠ¤ê°€ ì•„ë‹ˆë¼ ë°˜ë“œì‹œ 'íƒ­'ì„ ì‚¬ìš©í•´ì•¼ í•œë‹¤ëŠ” ì ì„ ì£¼ì˜í•˜ì.


## í…ŒìŠ¤íŠ¸ ê²°ê³¼

Lab ëª¨ë“ˆì€ í›Œë¥­í•œ í…ŒìŠ¤íŠ¸ ê²°ê³¼ ë¬¸ì„œë¥¼ ì œê³µí•œë‹¤.
Lab ëª…ë ¹ì–´ ì‹¤í–‰ì‹œ `-r` ì˜µì…˜ì€ ë¦¬í¬íŠ¸ í˜•ì‹ì„ ì •í•˜ëŠ” ì˜µì…˜ì´ë‹¤.
`-r html` ì˜µì…˜ì„ ì¤˜ì„œ html í˜•ì‹ìœ¼ë¡œ í…ŒìŠ¤íŠ¸ ê²°ê³¼ë¥¼ ì¶œë ¥í•˜ê³  `-o report.html` ì˜µì…˜ì„ ì¶”ê°€í•˜ì—¬ íŒŒì¼ë¡œ ì €ì¥í•  ìˆ˜ ìˆë‹¤.
Makefileì„ ì•„ë˜ì²˜ëŸ¼ ìˆ˜ì •í•´ ë³´ì.

```makefile
users:
  node_modules/lab/bin/lab -o report.html -r html app/routes/users/*.spec.js
```

## Gruntë¡œ ìë™í™”

ì§€ê¸ˆê¹Œì§€ì˜ ì‘ì—…ì„ Gruntë¡œ ìë™í™” í•´ë³´ì.
ìš°ë¦¬ëŠ” `grunt test` ë‹¨ í•œì¤„ì˜ ëª…ë ¹ì–´ë¡œ í…ŒìŠ¤íŠ¸ ì‹¤í–‰, ë¦¬í¬íŠ¸ ìƒì„± ë° ìƒì„±ëœ ë¦¬í¬íŠ¸ ì—´ëŒì˜ ì‘ì—…ì„ ìˆ˜í–‰í•  ìˆ˜ ìˆë‹¤.
ì•„ë˜ ëª…ë ¹ì–´ë¡œ grunt ê´€ë ¨ ëª¨ë“ˆì„ ì„¤ì¹˜í•œë‹¤.

```
npm install --save-dev grunt grunt-lab grunt-open
```

í”„ë¡œì íŠ¸ ë£¨íŠ¸ í´ë”ì— Gruntfile.jsë¥¼ ìƒì„±í•˜ê³  ì•„ë˜ ì½”ë“œë¥¼ ì‘ì„±í•œë‹¤.

```javascript
module.exports = function (grunt) {

  grunt.initConfig({

    // lab ëª…ë ¹ì–´ ê´€ë ¨ ì„¤ì •
    lab: {
      files: ['app/**/*.spec.js'], // ëª¨ë“  í…ŒìŠ¤íŠ¸ íŒŒì¼ì„ ìˆ˜í–‰í•œë‹¤.
      nodeEnv: 'development',
      DEBUG: '*',
      color: true,
      verbose: true,
      timeout: 7000,
      parallel: false,
      reportFile: 'report.html', // ë¦¬í¬íŠ¸ íŒŒì¼ì„ ìƒì„±í•œë‹¤.
      reporter: 'html',
      coverage: true
    },

    // ìƒì„±í•œ ë¦¬í”„í¬íŠ¸ íŒŒì¼ì„ í¬ë¡¬ ë¸Œë¼ìš°ì €ë¡œ ì—´ëŒí•œë‹¤.
    open: {
      report: {
        path: 'report.html',
        app: 'Google Chrome'
      }
    }

  });

  grunt.loadNpmTasks('grunt-lab');
  grunt.loadNpmTasks('grunt-open');

  grunt.registerTask('test', ['lab', 'open:report']);

};
```

ì´ì œ grunt test ëª…ë ¹ì–´ë¥¼ ìˆ˜í–‰í•´ë³´ì. ì‘ì„±í•œ ëª¨ë“  í…ŒìŠ¤íŠ¸ê°€ ì‹¤í–‰ë˜ê³ , report.htmlì— ê²°ê³¼ë¥¼ ì €ì¥í•œ ë’¤, í¬ë¡¬ ë¸Œë¼ìš°ì ¸ê°€ ì—´ë¦´ ê²ƒì´ë‹¤.

![](/assets/imgs/2015/hapi-test-run-grunt.png)
![](/assets/imgs/2015/hapi-test-coverage-1.png)
![](/assets/imgs/2015/hapi-test-coverage-2.png)



ì „ì²´ ì½”ë“œ:Â <a href="https://github.com/jeonghwan-kim/hapi_study/tree/09_test">https://github.com/jeonghwan-kim/hapi_study/tree/09_test</a>

ğŸ—‚ [ëª©ì°¨ ë°”ë¡œê°€ê¸°](/series/2015/02/13/hapijs-index.html)
