---
id: 199
title: Hapi ì¸ì¦
date: 2015-02-18T20:41:16+00:00
author: Chris
layout: post
guid: http://whatilearn.com/?p=199
permalink: /hapi-%ec%9d%b8%ec%a6%9d/
category: series
tags:
  - authentication
  - hapijs
---
ì´ë²ˆì—ëŠ” Hapi Api ì„œë²„ì˜ ì¸ì¦ ê¸°ëŠ¥ì„ êµ¬í˜„í•´ ë³´ì. <a href="https://github.com/hapijs/hapi-auth-cookie">hapi-auth-cookie</a> ëª¨ë“ˆì„ ì´ìš©í•˜ì—¬ <a href="http://www-01.ibm.com/support/knowledgecenter/SSPREK_8.0.0.2/com.ibm.amweb.doc_8.0.0.2/wrp_config/concept/con_sess_cookies_conc.html?lang=ko">ì„¸ì…˜ ì¿ í‚¤</a>ë¥¼ ì´ìš©í•˜ì—¬ ì¸ì¦ì„ êµ¬í˜„í•  ê²ƒì´ë‹¤. ì¸ì¦ ì •ë³´ë¥¼ ì„¸ì…˜ì— ì €ì¥í•˜ê³  í´ë¼ì´ì–¸íŠ¸ì™€ëŠ” ì¿ í‚¤ë¥¼ í†µí•´ ì¸ì¦ìƒíƒœë¥¼ í†µì‹ í•˜ë„ë¡ êµ¬í˜„í•œë‹¤.

<h2>ì„¸ì…˜ ì¸ì¦ í™œì„±í™”</h2>

Hapiì—ëŠ” ì„œë²„ê°ì²´ì˜ register() í•¨ìˆ˜ë¥¼ í†µí•´ í”ŒëŸ¬ê·¸ì¸ì„ ë“±ë¡í•  ìˆ˜ ìˆë‹¤. Hapiì—ì„œì˜ í”ŒëŸ¬ê·¸ì¸ì€ ìµìŠ¤í”„ë ˆìŠ¤ì˜ ë¯¸ë“¤ì›¨ì–´ì™€ ë¹„ìŠ·í•œ ê°œë…ì´ë‹¤. ì„¸ì…˜ ì¸ì¦ ëª¨ë“ˆ hapi-auth-cookieë¥¼ ë“±ë¡í•˜ê¸°ìœ„í•´ <code>server.register()</code> í•¨ìˆ˜ë¥¼ ì‚¬ìš©í•œë‹¤.

<pre class="lang:js decode:true" title="components/session/index.js">// Hapi ì„œë²„ ê°ì²´ë¥¼ ì´ìš©í•´ ì¸ì¦ ì„¤ì •ì„ í•œë‹¤.
module.exports = function (server) {

  // ì¸ì¦ ëª¨ë“ˆì„ ë“±ë¡í•œë‹¤.
  server.register(require('hapi-auth-cookie'), function (err) {
    if (err) {
      throw err;
    }

    // ì¸ì¦ strategy ë¥¼ ìƒì„±í•œë‹¤.
    server.auth.strategy('mySessionStrategy', 'cookie', {
      password: 'secret',
      cookie: 'sid-example',
      redirectTo: false,
      isSecure: false
    });
  });

};</pre>

ì¸ì¦ì—ëŠ” <code>scheme</code>ì™€ <code>strategy</code>ë¼ëŠ” ë‘ ê°€ì§€ ê°œë…ì´ ë“±ì¥í•œë‹¤. schemeì€ hapi-auth-cookie ëª¨ë“ˆì„ í†µí•´ ìƒì„±ë˜ëŠ”ë° ì„œë²„ì˜ ì¸ì¦ ë°©ë²•ì„ ì„¤ì •í•˜ëŠ” ê²ƒì´ë‹¤. hapiì—ì„œëŠ” schemeë³„ë¡œ ì¶”ê°€ì ì¸ ëª¨ë“ˆì„ ì œê³µí•œë‹¤.

<ul>
    <li><a href="https://github.com/hapijs/hapi-auth-basic">hapi-auth-basic</a></li>
    <li><a href="https://github.com/hapijs/hapi-auth-cookie">hapi-auth-cookie</a></li>
    <li><a href="https://github.com/hapijs/hapi-auth-hawk">hapi-auth-hawk</a>Â (ì˜ ëª¨ë¥´ê² ìŒ)</li>
</ul>

ì´ì™¸ì—ë„ ì„œë“œíŒŒí‹°ì—ì„œ ì œê³µí•˜ëŠ” shceme ëª¨ë“ˆì´ ìˆë‹¤.

<ul>
    <li><a href="https://github.com/j/hapi-auth-bearer">hapi-auth-bearer</a></li>
    <li><a href="https://github.com/asafdav/hapi-auth-extra">hapi-auth-extra</a></li>
</ul>

strategyëŠ” ì„œë²„ê°ì²´ì˜ <code>server.auth.strategy()</code> í•¨ìˆ˜ë¡œ ìƒì„±í•˜ëŠ”ë° ì„¸ë¶€ì ì¸ ì¸ì¦ ì •ì±…ì— ëŒ€í•œ ì •ì˜ë¼ê³  í•  ìˆ˜ ìˆë‹¤. ìœ„ ìƒ˜í”Œì½”ë“œì˜ ê²½ìš° ì„¸ì…˜ì¿ í‚¤ì— ëŒ€í•´ ë¹„ë°€ë²ˆí˜¸ ì„¤ì •, ì¿ í‚¤ëª…Â ì„¤ì •, ë¦¬íƒ€ì´ë ‰íŠ¸ ì •ì±… ì„¤ì •, secure ì„¤ì •ì„ ì •ì˜í•˜ê³  ìˆë‹¤.

ì„¸ì…˜ í”ŒëŸ¬ê·¸ì¸ì„ ì„¤ì •í•œ Hapi ì„œë²„ ê°ì²´ëŠ” request ê°ì²´ë¥¼ í†µí•´ ì„¸ì…˜ì„ ì‹œì‘í•˜ê³  ì¢…ë£Œí•  ìˆ˜ ìˆë‹¤.

<ul>
    <li>request.auth.session.set(): ì„¸ì…˜ ì‹œì‘</li>
    <li>request.auth.session.clear(): ì„¸ì…˜ ì¢…ë£Œ</li>
</ul>

ì´ ë‘ í•¨ìˆ˜ë¥¼ ì´ìš©í•´ ì„¸ì…˜ ì‹œì‘/ì¢…ë£Œ í•¨ìˆ˜ë¥¼ êµ¬í˜„í•œ ê²ƒì´ ì•„ë˜ ì½”ë“œë‹¤.

<pre class="lang:js decode:true" title="components/session/index.js ê³„ì† ">exports.startup = function (auth, data) {

  // ì‚¬ì „ ì¸ì¦ì •ë³´ê°€ ì—†ì„ ê²½ìš° ì„¸ì…˜ì— ì¸ì¦ì •ë³´ ì €ì¥
  if (!auth.isAuthenticated) {
    auth.session.set(data);
  }

};

exports.teardown = function (auth) {

  // ì„¸ì…˜ì •ë³´ ì‚­ì œ
  auth.session.clear();
};</pre>

ì´ìƒ Hapi ì„œë²„ì— ì„¸ì…˜ ì¿ í‚¤ ì¸ì¦ì„ ìœ„í•œ í™˜ê²½ì„¤ì •ì„ ë§ˆì³¤ë‹¤. ì´ì œëŠ” ì‹¤ì œ ì¸ì¦ì„ ìœ„í•œ í”„ë¡œí† ì½œì¼ login, logoutì„ êµ¬í˜„í•´ ë³´ì.

<h2>ë¼ìš°íŒ… ì„¤ì •</h2>

í”„ë¡œí† ì½œì€ ìµœëŒ€í•œ RESTful í•˜ê²Œ ì‘ì„±í•˜ê¸° ìœ„í•´ ì•„ë˜ì™€ ê°™ì´ êµ¬í˜„í•œë‹¤.

<ul>
    <li>/auth (post): ë¡œê·¸ì¸, ì¸ì¦ íŒŒë¼ë©”í„°ëŠ” payloadë¡œ ë°›ëŠ”ë‹¤. ì¸ì¦ì„±ê³µì‹œ 201, ì‹¤íŒ¨ì‹œ 403ì½”ë“œë¥¼ ë°˜í™˜í•œë‹¤.</li>
    <li>/auth (delete): ë¡œê·¸ì•„ì›ƒ</li>
    <li>/auth (get): í…ŒìŠ¤íŠ¸ìš© í”„ë¡œí† ì½œ. ì„¸ì…˜ ì •ë³´ë¥¼ í™•ì¸í•œë‹¤.</li>
</ul>

ìš°ì„  ìœ„ í”„ë¡œí† ì½œì— ëŒ€í•œ ë¼ìš°íŒ… ì„¤ì •í•˜ëŠ” ë¶€ë¶„ì´ë‹¤. route() í•¨ìˆ˜ ì„¤ì • ê°ì²´ì˜ ì†ì„±ì¤‘ config.auth í‚¤ë¥¼ í†µí•´ ì¸ì¦ ì •ì±…ì„ ì„¤ì •í•œë‹¤. <code>mode</code>ëŠ” 'try', 'required' ë‘ ê°€ì§€ íƒ€ì…ì„ ì„¤ì •í•  ìˆ˜ ìˆë‹¤. ë¡œê·¸ì¸ì˜ ê²½ìš° 'try'ë¥¼ ì„¤ì •í•˜ê³  ì¸ì¦ëœ ìƒíƒœì—ì„œ ì ‘ê·¼í• ìˆ˜ ìˆëŠ” í”„ë¡œí† ì½œì€ 'required'ë¥¼ ì„¤ì •í•œë‹¤. <code>strategy</code>ëŠ” server.auth.strategy() í•¨ìˆ˜ë¡œ ìƒì„±í•œ strategyë¥¼ ë¬¸ìì—´ë¡œ ì„¤ì •í•œë‹¤.

<pre class="lang:js decode:true" title="routes/auth/index.js">var ctrl = require('./auth.ctrl.js');

module.exports = function (server) {

  // ë¡œê·¸ì¸
  server.route({
    method: 'POST',
    path:'/auth',
    handler: ctrl.login,
    config: {
      auth: {
        mode: 'try', // ì¸ì¦ ì‹œë„
        strategy: 'mySessionStrategy' // ì‚¬ìš©í•  strategy
      }
    }
  });

  // ë¡œê·¸ì•„ì›ƒ
  server.route({
    method: 'DELETE',
    path:'/auth',
    handler: ctrl.logout,
    config: {
      auth: {
        mode: 'required', // ì¸ì¦ í•„ìˆ˜
        strategy: 'mySessionStrategy'
      }
    }
  });

  // ì„¸ì…˜ í™•ì¸ (ê°œë°œìš©)
  server.route({
    method: 'GET',
    path:'/auth',
    handler: ctrl.find,
    config: {
      auth: {
        mode: 'required',
        strategy: 'mySessionStrategy'
      }
    }
  });

};</pre>

<h2>ì»¨íŠ¸ë¡¤ëŸ¬ ë¡œì§</h2>

ë¡œê·¸ì¸ ì‹œë‚˜ë¦¬ì˜¤ëŠ” ì´ë ‡ë‹¤. /auth (post) í”„ë¡œí† ì½œì„ í†µí•´ ì¸ì¦ ì‹œë„ â†’ ì¸ì¦ ì •ë³´ ê²€ì¦ â†’ ê²€ì¦ì— í†µê³¼í•˜ë©´ ì„¸ì…˜ì— ìœ ì €ì •ë³´ ì €ì¥ â†’ í´ë¼ì´ì–¸íŠ¸ì— ì¸ì¦ ì„±ê³µ ì •ë³´ë¥¼ ì‘ë‹µ. ì•„ë˜ ì½”ë“œì™€ ì£¼ì„ì„ ê°™ì´ ì‚´í´ë³´ì.

<pre class="lang:js decode:true" title="routes/auth/auth.ctrl.js">'use strict';

// ìœ„ì—ì„œ êµ¬í˜„í•œ ì„¸ì…˜ ëª¨ë“ˆ. ì´ê²ƒì„ í†µí•´ì„œ ì„¸ì…˜ ì‹œì‘/ì¢…ë£Œ í•  ìˆ˜ ìˆë‹¤.
var session = require('../../components/session');

exports.login = function (req, reply) {
  var user = {
    username: 'Chris',
    password: 'chrisPass'
  };

  // ì¸ì¦ ì •ë³´ ê²€ì¦
  if (user.username !== req.payload.username || user.password !== req.payload.password) {
    return reply(403);
  }

  // ì„¸ì…˜ ì‹œì‘, ìœ ì €ì •ë³´ ì €ì¥
  session.startup(req.auth, user);

  // ì¸ì¦ ì„±ê³µ ì •ë³´ë¥¼ ì‘ë‹µ
  reply(user).code(201);
};</pre>

ë¡œê·¸ì•„ì›ƒì€ ì„¸ì…˜ì„ ì‚­ì œí•˜ê³  ì‘ë‹µí•œë‹¤. findëŠ” ì„¸ì…˜ í™•ì¸ìš©ì´ë‹¤.

<pre class="lang:js decode:true " title="routes/auth/auth.ctrl.js">exports.logout = function (req, reply) {

  // ì„¸ì„  ì¢…ë£Œ
  session.teardown(req.auth);

  // ì‘ë‹µ
  reply();
};

// ì„¸ì…˜ í™•ì¸ìš©
exports.find = function (req, reply) {
  reply(req.auth);
};</pre>

ì´ìƒìœ¼ë¡œ ë¡œê·¸ì¸/ë¡œê·¸ì•„ì›ƒ í”„ë¡œí† ì½œì„ êµ¬í˜„í–ˆë‹¤. ì‹¤ì œ ë¡œê·¸ì¸, ë¡œê·¸ì•„ì›ƒ í”„ë¡œí† ì½œ ê²°ê³¼ë¥¼ ì²¨ë¶€í•œë‹¤.

ë¡œê·¸ì¸:

![login](/assets/imgs/2015/login.png)

ì„¸ì…˜í™•ì¸:

![get-auth](/assets/imgs/2015/get-auth.png)

ë¡œê·¸ì•„ì›ƒ:

![logout](/assets/imgs/2015/logout.png)


&nbsp;

ì „ì²´ ì½”ë“œ:Â <a href="https://github.com/jeonghwan-kim/hapi_study/tree/08_auth%EA%B5%AC%ED%98%84">https://github.com/jeonghwan-kim/hapi_study/tree/08_authêµ¬í˜„</a>

ğŸ—‚ [ëª©ì°¨ ë°”ë¡œê°€ê¸°](/series/2015/02/13/hapijs-index.html)