---
title: "node-sass가 노드 버전에 의존적이 이유"
layout: post
category: dev
tags: [sass]
---

스타일시트 전처리 언어 중 sass를 사용하는데 노드 환경에서는 [node-sass](https://github.com/sass/node-sass)를 이용해서 코드를 css로 변환한다.
먼저는 less를 먼저 사용했는데 c언어 구현체가 있는 sass는 빌드 속도가 비교적 빠른 것이 특징이라고 했던 것 같다.
요즘엔 거의 sass만 사용한다.

sass 환경의 프로젝트를 사용하다 보면 가끔 이러한 오류를 접하게 된다.

```
Error: Node Sass does not yet support your current environment: OS X 64-bit with Unsupported runtime (83)
For more information on which environments are supported please see:
```

보통 노드 버전을 올린 뒤 나오는 메세지다.

이럴 때는 node-sass 최신 버전을 설치해서 이 문제를 해결해 왔는데 딱히 뭐라고 원인을 설명할 수 없었다. 
'이 패키지가 노드 버전을 타는구나' 정도로만 어렴풋이 이해하고 있었다.

저 메세지를 단서로 원인을 좀 찾아 보았다. 

# 오류 메세지의 원인 

node-sass에서 메세지가 나오는 경로는 이러하다. 

```js
// lib/index.js
var binding = require('./binding')(sass); 
```

프로젝트 진입점에서 binding 모듈을 가져와서 실행한다.

```js
// lib/binding.js
if (!ext.isSupportedEnvironment())  
```

바인딩 모듈에서 지원하는 환경을 점검한다. 

```js
// lib/extensions.js
function getHumanNodeVersion(abi)  
  switch (parseInt(abi || process.versions.modules, 10)) {
    case 11: return 'Node 0.10.x';
    case 14: return 'Node 0.12.x';
    case 42: return 'io.js 1.x';
    case 43: return 'io.js 1.1.x';
    case 44: return 'io.js 2.x';
    // ... 
    default: return false;
```

여러 환경 정보 중 노드 버전을 검사하는 로직이다. 
process.versions 객체로 노드 버전을 체크하는데 찾고자 하는 버전이 없으면 false를 반환한다.

```js
// lib/binding.js 
throw new Error(errors.unsupportedEnvironment()); 
```

false를 받으면 환경 정보 점검에 실패하고 정의된 오류 메세지를 예외로 던진다. 
unsupportedEnvironment() 함수가 바로 우리가 찾던 오류메세지를 반환한다.

현상을 재현해보면 

- node-sass@4.13.0(구 버전)을 사용한다고 가정했을 경우 
- [getHumanNodeVersion()](https://github.com/sass/node-sass/blob/v4.13.0/lib/extensions.js#L81) 함수에서 체크하는 노드 버전이 13까지 밖에 없다
- node@13(구 버전)을 사용하면 이 버전 체크에 통과한다
- node@14(신 버전)로 올리면 node-sass 구버전에서는 지원하지 않는 버전이므로 예외를 던진다 

이러한 방식으로 node-sass는 지원하는 노드 버전을 체크하고 미지원 버전에서는 동작을 멈추고 종료하는 것이다.

# node-sass는 왜 노드 버전을 체크하는 것일까?

그럼 node-sass는 무엇 때문에 노드 버전을 체크하는 것일까? 

그전에 [libsass](https://sass-lang.com/libsass)를 먼저 봐야겠다.
sass는 원래 루비 환경에서 사용할 수 있는 도구였다. 
이걸 다른 환경에서도 지원하기 위해 c/c++로 만든 것이 libsass다. 
이것은 라이브러리 일뿐이지 sass 파일을 컴파일하기 위해서는 임플리멘터(implementer)가 필요하다.
노드, 펄, 파이썬, 자바 등 다양한 환경에서 사용하기 위한 임플리멘터가 있다. 
node-sass도 이들 중 하나인데 libsass를 노드 환경에서 사용하기 위한 도구이다.

c/c++로 만든 코드를 노드에서 실행시키는 방법은 뭘까?
노드는 자바스크립트와 c/c++ 라이브러리 간의 인터페이스를 제공해 주는데 바로 [C++ 애드온](https://nodejs.org/api/addons.html)이라고 한다.

node-sass도 c++ 애드온을 이용해 libsass를 노드에서 사용한다.
하지만 c++ 애드온이 자바스크립트 코드를 해석하는 v8 버전에 의존적이라는 것이 문제다. 
v8 엔진이 업그레이드 되면 c++ 애드온이 제공하는 인터페이스도 맞추어야 하기 때문이다.
보통 노드 메이저 업데이트가 되면 v8 버전도 올라가면서 애드온도 수정해야한다.
그래서 node-sass도 node 버전에 따라 업데이트 버전을 제공하는 것 같다. 
- [Supported Node.js versions](https://github.com/sass/node-sass/#supported-nodejs-versions-vary-by-release-please-consult-the-releases-page-below-is-a-quick-guide-for-minimum-support)

이러한 의존성 문제를 해결하기 위한 방법도 있는 것 같다(참고: https://aerocode.net/341).
NAN과 N-API가 있는데 간단히 정리하면 
- NAN(Native Abstractions for Node): 위에서 설명한 방식
- N-API(ApiNext Generation Node API): 

node-sass가 NAN 방식으로 애드온을 사용하고 현재는 N-API 방식으로 바꾸는 작업을 하는 것 같다.
- https://github.com/sass/node-sass/pull/2440



# 결론 

노드 업데이트 전에 node-sass 지원 여부를 확인하자.

노드 메이저 업데이를 할때는 node-sass 최신 버전을 사용하자.

N-API 방식으로 바뀐다면 이런 뒤치닥거리를 하지 않아도 되지 않을까 기대해 본다.
