---
title: "react-helmet의 동작 방식"
layout: post
category: dev
tags: [react, gatsby]
---

Gatsby.js 프로젝트를 보면서 react-helmet을 발견했다.
개발 용어로 헬멧이라는 단어는 친숙한데 노드의 웹 프레임웍인 익스프레스에서 본 기억이 있다.
보안 관련한 익스프레스 미들웨어인데 이름처럼 웹 어플리케이션을 안전하게 지켜 주는 그런 도구다.

react-helmet도 비슷한 것인가하고 지나쳤더니 전혀 아니더라.
웹 문서의 헤더 값을 변경하는 리액트 컴포넌트다.
헬멧을 머리에 쓰는 것처럼 문서의 머리(head)를 관리한다고해서 그렇게 이름 짓지 않았는가 싶다.

이번에 블로그를 개츠비로 옮기면서 이 라이브러리를 사용했는데 비교적 쾌적한 느낌으로 사용했다.
기존에 템플릿 문법으로 문서 헤더를 관리했던 것을 리액트 컴포넌트 방식으로 헤더를 관리할 수 있었다.
간단히 이 도구에 대해 정리해 보자.

# 필요한 경우

언제 헤더를 변경해야 할까?
리액트로 개발할 때 보통은 마운트 된 바디(boyd) 안의 특정 요소에서만 작업하기 때문에 별로 신경쓸 일이 없었다.
그리고 이미 서버에서 헤더값을 계산해서 브라우져로 내려주었기 때문에 관리할 필요가 없었다.

## 문서 타이틀을 변경할 때

싱글 페이지 어플리케이션은 화면을 이동할 때마다 페이지를 요청하는 것이 아니다.
그렇기 때문에 문서의 타이틀은 초기에 서버에서 받은 값 그대로 사용하게 된다.
화면 이동에 따른 타이틀을 변경하려면 헤더를 동적으로 변경해야만 한다.

## 소셜에 포스팅 할 때

페이스북이나 sns에 페이지 링크를 포스팅할 때 페이지 썸네일과 타이틀을 조합해서 이쁘게 만들어 주는 경우가 있다.

![페이스북 포스팅]()
![트위터 포스팅]()

소셜 서비스에서 링크를 포스팅 할 때 링크의 og 태그의 값을 가져와 이런 컨텐츠를 만든다.
og 태그는 헤더 안에 있는 메타 태그로 작성한다.

```html
<head>
  <meta />
</head>
```

소셜 서비스에 알맞게 포스팅하기 위해서는 헤더값을 관리해야할 필요가 있다.

## 검색엔진 최적화가 필요할 때

검색엔진은 문서 전체를 읽기 때문에 적절한 헤더 관리가 필요하다.
내 경우에는 구글 검색결과에 날짜를 표시하기 위해서 몇가지 정보를 헤더에 담았다.
article:published_time, application/ld+json

# 사용방법

그럼 react-helmet으로 어떻게 이러한 헤더 값을 관리할 수 있을까?
리액트 컴포넌트 방식으로 일관되게 사용하는 방법을 제공하다.

라이브러리는 리액트 프레임웍에서 사용할 수 있도록 <Helmet> 컴포넌트를 제공한다.
렌더 함수에서 이 컴포넌트로 헤더값을 설정할 수 있다.

```tsx
import { Helmet } from "react-helmet"

const SEO = () => {
  return <Helmet title="타이틀" />
}
```

프롭스로 전달하는 방식이 있는가 하면 자식 컴포넌트로 설정할 수도 있다.

```tsx
<Helmet>
  <title>타이틀</title>
</Helmet>
```

# 동작 원리

렌더 함수에 선언했다는 것은 리액트 어플리케이션이 마운트된 곳에 자식으로 그려질것이라 생각할 수 있다.
그런데 헤더는 문서의 body가 아닌 head 영역에 있는데 어떻게 이런 결과가 나오는 것일까?

react-helmet은 DOM API를 사용해서 직접 헤더를 변경하는 방식이다([참고](https://github.com/nfl/react-helmet/blob/master/src/HelmetUtils.js#L372)).

```ts
const updateTitle = (title, attributes) => {
  // DOM 객체의  title 속성을 직접 변경한다
  document.title = flattenArray(title)
}
```

싱글 페이지 어플리케이션을 개발할 때 타이틀 정보를 자바스크립트로 변경하려고 document.title을 직접 설정했던 기억이 있다.
그땐 이렇게 하는게 맞아? 라고 생각하면서 만들었는데 이 방식이 잘 동작하는건가 보다.

메타 태그도 DOM API를 사용해서 변경한다.

head 안에 있는 메타태그도 문서의 일부분이기 때문에 DOM API로 접근할 수있다.
적절한 셀렉터로 돔에 접근한 다음 속성값을 변경하는 방식을 사용한다.

```ts
const ogTitle = document.querySelector('meta[property="og:title"]')
ogTitle.getAttribute("conetnt") // null
ogTitle.setAttribute("content", "SNS에 공유할 타이틀 입니다")
```

# 크롤러가 읽을 수 있을까?

기본적으로 크롤러는 html 문서를 읽는다고 알고 있다.
문서를 로딩한 뒤 실행되는 자바스크립트가 변경하는 내용을 크롤러마다 다르게 해석한다.
그래서 검색 엔진 최적화를 위해서 항상 서버사이드에서 만든 문서에 노출할 내용을 담아야한다.

그런데 게츠비에 보면 직접 사용하고 있더라.
그래서 한 번 페이스북, 트위터, 구글이 react-helmet이 만들어내는 헤더값에 어떻게 반응하는지 실험해 봤다.

포스팅을 위한 og 태그를 몇개 등록했다.

```tsx
<Helmet
  meta={[
    { name: "og:title", content: "타이틀" },
    { name: "og:description", content: "포스트의 설명입니다." },
    { name: "og:image", content: "// 이미지 주소" },

    { name: "twitter:title", content: "타이틀" },
    { name: "twitter:description", content: "포스트의 설명입니다." },
    { name: "twitter:image", content: "// 이미지 주소" },
  ]}
/>
```

먼저 페이스북은 글 작성시에는 데이터를 못가져 오다가 포스트를 등록하고 나면 og 태그에 있는 값을 이용해 게시물을 만들었다.
아마도 크롤러가 자바스크립트까지 동작시켜서 화면의 데이터를 가져오는 듯 싶다.

반면 트위터는 아무것도 가져오지 못했다.

구글 검색은 react-helmet으로 만들 데이터를 가져오지 못한다는 이슈가 등록되어 있다[Googlebot not crawling React Helmet title and meta description on homepage](https://github.com/nfl/react-helmet/issues/377).

그럼 게츠비는 react-helmet을 어떻게 사용하고 있는걸까?

게츠비 플러그인은 게츠비를 확장할 수 있는 방법을 제공하는데 gatsby-plugin-react-helmet이 react-helmet을 서버사이드 렝더링시에 유효하도록 하는 도구다.
리액트 컴포넌트 방식으로 헤더 값을 지정했고 브라우져에서 이를 넣었지만 게츠비에서 빌드하여 정적사이트를 만들어 낼때 이 정보를 헤더 포함하도록 해주는 것이 이것의 역할이다.

# 결론

주로 어드민을 만들어서 그런지 검색엔진이나 소셜 공유를 고려했던 경험이 부족했다.
B2C 서비스를 만들려면 이러한 기능은 서비스의 중요한 부분일 것이라 생각한다.

간단히 타이틀 정도만 바꿔서 유저에게 보여줄 정도라면 react-helmet을 바로 사용해도 되겠다.

그렇지만 검색엔진과 소셜 공유를 해야한다면 서버사이드 렌더링이 필요한 것이 필요하다.

혹시나해서 Vue.js 쪽에도 찾아봤다. vue-meta라는 라이브러리가 있었고 컴포넌트 방식의 react-helmet과는 달리
설정 객체를 전달하는 것 같다. 기회가 되면 더 자세히 봐야겠다.
